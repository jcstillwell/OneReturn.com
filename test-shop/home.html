<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Widget Integration Example</title>
    <style>
        /* Basic styling for item containers */
        .item {
            border: 1px solid #ccc;
            margin: 10px;
            padding: 10px;
            display: inline-block;
        }
        .widget-add-to-list {
            margin-top: 10px;
            display: inline-block;
            cursor: pointer;
        }
    </style>
</head>
<body>
<div className="main-container">
    <div class="item" data-name="Nike Air Max 270" data-original-vendor="Nike" data-item-category="Shoes" data-item-sku="NAM270" data-price="150" data-payment-method="Credit Card">
        Nike Air Max 270 - $150
        <button class="widget-add-to-list">Add to List</button>
    </div>
    
    <div class="item" data-name="Adidas Ultraboost 21" data-original-vendor="Adidas" data-item-category="Shoes" data-item-sku="AUB21" data-price="180" data-payment-method="PayPal">
        Adidas Ultraboost 21 - $180
        <button class="widget-add-to-list">Add to List</button>
    </div>
    
    <div class="item" data-name="Nike Sportswear Tech Fleece" data-original-vendor="Nike" data-item-category="Clothing" data-item-sku="NSTF" data-price="100" data-payment-method="Credit Card">
        Nike Sportswear Tech Fleece - $100
        <button class="widget-add-to-list">Add to List</button>
    </div>
    
    <div class="item" data-name="Adidas Originals Firebird Track Jacket" data-original-vendor="Adidas" data-item-category="Clothing" data-item-sku="AOFBTJ" data-price="75" data-payment-method="PayPal">
        Adidas Originals Firebird Track Jacket - $75
        <button class="widget-add-to-list">Add to List</button>
    </div>
    
    <div class="item" data-name="Puma Essential Logo Hoodie" data-original-vendor="Puma" data-item-category="Clothing" data-item-sku="PELH" data-price="60" data-payment-method="Credit Card">
        Puma Essential Logo Hoodie - $60
        <button class="widget-add-to-list">Add to List</button>
    </div>
    
    <div class="item" data-name="Under Armour Charged Assert 8" data-original-vendor="Under Armour" data-item-category="Shoes" data-item-sku="UACA8" data-price="70" data-payment-method="PayPal">
        Under Armour Charged Assert 8 - $70
        <button class="widget-add-to-list">Add to List</button>
    </div>
    
    <div class="item" data-name="New Balance Fresh Foam 1080v11" data-original-vendor="New Balance" data-item-category="Shoes" data-item-sku="NBFF1080" data-price="150" data-payment-method="Credit Card">
        New Balance Fresh Foam 1080v11 - $150
        <button class="widget-add-to-list">Add to List</button>
    </div>
    
    <div class="item" data-name="Reebok Classic Leather" data-original-vendor="Reebok" data-item-category="Shoes" data-item-sku="RCL" data-price="75" data-payment-method="PayPal">
        Reebok Classic Leather - $75
        <button class="widget-add-to-list">Add to List</button>
    </div>
    
    <div class="item" data-name="Vans Old Skool" data-original-vendor="Vans" data-item-category="Shoes" data-item-sku="VOS" data-price="60" data-payment-method="Credit Card">
        Vans Old Skool - $60
        <button class="widget-add-to-list">Add to List</button>
    </div>
    
    <div class="item" data-name="Converse Chuck Taylor All Star" data-original-vendor="Converse" data-item-category="Shoes" data-item-sku="CTAS" data-price="55" data-payment-method="PayPal">
        Converse Chuck Taylor All Star - $55
        <button class="widget-add-to-list">Add to List</button>
    </div>
</div>
<button id="authButton">Track this receipt with OneReturn</button>
<button id="checkout">Checkout</button>

<!-- More items can be added following the same structure -->

<script>

var itemList = [];
var sessionToken;
var recipientID;
var prod = false;

function openAuthPopup() {
    const popupUrl = prod ? "https://api.onereturn.com/externalauth" : "http://localhost:3000/externalauth";
    const popupDim = 'width=400,height=600';
    extAuth = window.open(popupUrl, 'external-auth', popupDim);
    console.log(window.location.hostname + ":" + window.location.port);

    setTimeout(() => {
        const message = "http://" + window.location.hostname + ":" + window.location.port;
        const targetOrigin = prod ? "https://api.onereturn.com" : "http://localhost:3000";
        extAuth.postMessage({
            "type": "or-merchant-popup-msg",
            "data": message,
            }, targetOrigin);
    }, 2000);
}


//If you are having an issue w this, load up the merchant frontend and make a merchant account first ;)
function checkout() {

    formattedList = 

    fetch(prod ? 'https://onereturn.com/userapi/authenticateMerchant/' : "http://localhost:8000/authenticateMerchant/", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            'merchantID': 'JstillwelGtRFgnYemKNT5Q5r',
            'method': 'external',
            'merchantAPIKey': '41c48c2e-831a-4646-a962-fb0e2db8b0fa',
            'masterPassword': '123',
        }),
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        sessionToken = data.sessiontoken
        console.log(sessionToken);
        fetch(prod ? 'https://api.onereturn.com/api/createinvoice/' : 'http://localhost:8000/api/createinvoice/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Token ' + sessionToken,
            },
            body: JSON.stringify({
        invoice: {
            recipientID: recipientID,
            merchantID: 'JstillwelGtRFgnYemKNT5Q5r',
            merchantLocNumber: 'LocationNumber',
            merchantAddress: 'MerchantAddress',
            merchantName: 'MerchantName',
            invoiceID: [...Array(11)].map(() => Math.random().toString(36)[Math.random() < 0.5 ? 2 : Math.floor(Math.random() * 10 + 3)]).join(''),
            dateCreated: '2023-04-12T14:12:00Z',
            // Continue with other fields...
        },
        items: itemList,
        api_key: '41c48c2e-831a-4646-a962-fb0e2db8b0fa'

    }),
})
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        console.log(data);
    })
    .catch((error) => {
        console.error('There was a problem with your fetch operation:', error);
    });
    })
    .catch((error) => {
        console.error('There was a problem with your fetch operation:', error);
    });
    
    for (const i in itemList) {
        const item = itemList[i]
    }
}

document.getElementById('checkout').addEventListener('click', checkout)
document.getElementById('authButton').addEventListener('click', openAuthPopup)

window.addEventListener('message', function(event) {
    // Check the origin to ensure the message is from a trusted source
    if (event.origin !== (prod ? "https://api.onereturn.com" : "http://localhost:3000")) {
        console.log('Message received from untrusted origin, ignoring.');
        return;
    }

    if (event.data) {
        recipientID=event.data;
        console.log(recipientID);
    }

    else {
        console.log("?")
    }
});

// Widget's JavaScript to automatically attach event listeners and manage the item list
document.addEventListener('DOMContentLoaded', function() {

    document.querySelectorAll('.widget-add-to-list').forEach(function(button) {
        button.addEventListener('click', function() {
            var itemElement = this.closest('.item');
            var itemDetails = {
                name: itemElement.getAttribute('data-name'),
                returned: false,
                returnedBy: null, 
                updated_at: '2023-04-12T14:12:00Z',
                originalVendor: itemElement.getAttribute('data-original-vendor'),
                itemCategory: itemElement.getAttribute('data-item-category'),
                itemSku: itemElement.getAttribute('data-item-sku'),
                price: parseFloat(itemElement.getAttribute('data-price')), 
                paymentMethod: itemElement.getAttribute('data-payment-method'),
                cardInfo: '1234', 
            };
            
            // Add the item details to the list
            itemList.push(itemDetails);

            // Demonstration: Log the current list of items to the console
            console.log(itemList);
            
            // Here, you could also update a UI element to show the item list to the user
            // Or enable a button for the user to "checkout" or review their list
        });
    });
});
</script>

</body>
</html>
